#' @title convertCEDS2021
#' 
#' @description converts emission data from the CEDS database
#' @param x magpie object from source function
#' @return MAgPIE object
#' @author Benjamin Leon Bodirsky, David Klein

convertCEDS2021 <- function(x) {
  
  # fill all missing countries with 0
  x[is.na(x)] <- 0
  
  # change unit to Mt
  x=x/1000

  x1 <- x["srb (kosovo)",,]
  getRegions(x1) <- c("srb")
  x["srb",,] <- x["srb",,] + x1
  x          <- x[c("srb (kosovo)"),,,invert=TRUE]
  
  getRegions(x) <- gsub("global","glo", getRegions(x))
  getRegions(x) <- toupper(getRegions(x))
  
  map2 <- c(BC_ktC="bc_c",
            CO_ktCO="co",
            CH4_ktCH4="ch4",
            N2O_ktN2O="n2o_n",
            NH3_ktNH3="nh3_n",
            NOx_ktNO2="no2_n",
            NMVOC_ktNMVOC="nmvoc",
            OC_ktC="oc_c",
            SO2_ktSO2="so2",
            CO2_ktCO2="co2_c"
            )
  getNames(x,dim=2) <- map2[getNames(x,dim=2)]
  
  x[,,"n2o_n"]=x[,,"n2o_n"]/44*28
  x[,,"nh3_n"]=x[,,"nh3_n"]/17*14
  x[,,"no2_n"]=x[,,"no2_n"]/46*14
  x[,,"co2_c"]=x[,,"co2_c"]/44*12
  
  
  

  # most shipping and aviation data is global only (except 1A3dii_Domestic-navigation regional). We want to distribute it evenly across all countries.
  # Therefore, save global data because it will be removed by toolCountryfill
  
  # 1A3dii_Domestic-navigation   regional (global value is zero )
  # 1A3di_International-shipping global   (no regional values exist)
  # 1A3ai_International-aviation global   (no regional values exist)
  # 1A3aii_Domestic-aviation     global   (no regional values exist)
  
  var_glob <- c("1A3di_International-shipping",
                "1A3ai_International-aviation",
                "1A3aii_Domestic-aviation")
  x_glo <- x["GLO",,var_glob] 
  
  # remove global values. Note: the sector 2A1_Cement-production has a global sum that is indentical to the sum over regions
  x <- x["GLO",,invert=TRUE]
  # fills missing ISO countires and remove unknown ISO countires
  x <- toolCountryFill(x,fill=0)
  
  # Create weight 1 for x_glo
  w <- new.magpie(getRegions(x),getYears(x),getNames(x_glo),fill=1)
  
  # Create mapping of each country to GLO
  mapping <- matrix(c(getRegions(x),rep("GLO",length(getRegions(x)))),length(getRegions(x))) 
  
  # Spread global shipping and aviation data evenly across countries and save it to regions of x
  x[,,var_glob] <- toolAggregate(x_glo,mapping,weight=w)
  
  return(x)
}  